<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link href="https://fonts.googleapis.com/css?family=Bitter:400,700&display=swap&subset=latin-ext"
        rel="stylesheet" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>ForzaRadio - IA Music Player</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="icon" id="icon" href="https://forzayt.github.io/assets/emoji.png" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* author: Muhammed Erdem
https://codepen.io/JavaScriptJunkie/pen/qBWrRyg */
@import url("https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css");
body {
  background: #dfe7ef;
  font-family: "Bitter", serif;
  display: grid;
  place-items: center;
  overflow: hidden;
  cursor: crosshair;
}

.background {
  position: fixed;
  width: 200%;
  height: 200%;
  top: -50%;
  left: -50%;
  z-index: -1;
}

.background img {
  position: absolute;
  margin: auto;
  top: 0; left: 0; bottom: 0; right: 0;
  min-width: 50%;
  min-height: 50%;
  filter: blur(15px);
  -webkit-filter: blur(50px);
  transform: scale(1.1);
  transition: opacity 0.5s ease-in-out;
  opacity: 1;
}

* {
  box-sizing: border-box;
}

.icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}

.wrapper {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  background-size: cover;
}
@media screen and (max-width: 700px), (max-height: 500px) {
  .wrapper {
    flex-wrap: wrap;
    flex-direction: column;
  }
}

.player {
  background: rgba(238, 243, 247, 0.25);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  width: 500px;
  min-height: 580px;
  box-shadow: 
    0px 15px 35px -5px rgba(50, 88, 130, 0.32),
    0 8px 32px rgba(0, 0, 0, 0.1),
    inset 0 1px 0 rgba(255, 255, 255, 0.2);
  border-radius: 15px;
  padding: 40px;
  border: 1px solid rgba(255, 255, 255, 0.18);
}
@media screen and (max-width: 576px), (max-height: 500px) {
  .player {
    width: 95%;
    padding: 20px;
    margin-top: 75px;
    min-height: initial;
    padding-bottom: 30px;
    max-width: 400px;
  }
}
.player__top {
  display: flex;
  align-items: flex-start;
  position: relative;
  z-index: 4;
}
@media screen and (max-width: 576px), (max-height: 500px) {
  .player__top {
    flex-wrap: wrap;
  }
}
.player-cover {
  width: 340px;
  height: 340px;
  margin-left: -80px;
  flex-shrink: 0;
  position: relative;
  z-index: 2;
  border-radius: 15px;
  z-index: 1;
}
@media screen and (max-width: 576px), (max-height: 500px) {
  .player-cover {
    margin-top: -70px;
    margin-bottom: 25px;
    width: 300px;
    height: 260px;
    margin-left: auto;
    margin-right: auto;
  }
}
.player-cover__item {
  background-repeat: no-repeat;
  background-position: center;
  background-size: cover;
  width: 100%;
  height: 100%;
  border-radius: 15px;
  position: absolute;
  left: 0;
  top: 0;
  transition: all 0.5s ease-in-out;
  opacity: 1;
  box-shadow: 
    0 20px 40px rgba(0, 0, 0, 0.3),
    0 8px 16px rgba(0, 0, 0, 0.2),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);
  transform: scale(1.02);
}
.player-cover__item:before {
  content: "";
  background: inherit;
  width: 100%;
  height: 100%;
  box-shadow: 
    0px 15px 50px 0px rgba(76, 70, 124, 0.6),
    0px 8px 25px 0px rgba(0, 0, 0, 0.4);
  display: block;
  z-index: 1;
  position: absolute;
  top: 35px;
  transform: scale(0.85);
  filter: blur(15px);
  opacity: 0.8;
  border-radius: 15px;
}
.player-cover__item:after {
  content: "";
  background: inherit;
  width: 100%;
  height: 100%;
  box-shadow: 
    0px 10px 40px 0px rgba(76, 70, 124, 0.5),
    0 0 0 2px rgba(255, 255, 255, 0.1);
  display: block;
  z-index: 2;
  position: absolute;
  border-radius: 15px;
  border: 2px solid rgba(255, 255, 255, 0.15);
}
.player-cover__img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 15px;
  box-shadow: 0px 10px 40px 0px rgba(76, 70, 124, 0.5);
  user-select: none;
  pointer-events: none;
  transition: all 0.5s ease-in-out;
  opacity: 1;
}

/* Hover effects for album art */
.player-cover:hover .player-cover__item {
  transform: scale(1.05);
  box-shadow: 
    0 25px 50px rgba(0, 0, 0, 0.4),
    0 12px 20px rgba(0, 0, 0, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.player-cover:hover .player-cover__item:before {
  transform: scale(0.8);
  filter: blur(20px);
  opacity: 0.7;
}
.player-controls {
  flex: 1;
  padding-left: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
}
@media screen and (max-width: 576px), (max-height: 500px) {
  .player-controls {
    flex-direction: row;
    padding-left: 0;
    width: 100%;
    flex: unset;
  }
}
.player-controls__item {
  display: inline-flex;
  font-size: 35px;
  padding: 8px;
  margin-bottom: 15px;
  color: rgba(255, 255, 255, 0.9);
  cursor: pointer;
  width: 60px;
  height: 60px;
  align-items: center;
  justify-content: center;
  position: relative;
  transition: all 0.3s ease-in-out;
}
@media screen and (max-width: 576px), (max-height: 500px) {
  .player-controls__item {
    font-size: 26px;
    padding: 5px;
    margin-right: 10px;
    color: rgba(255, 255, 255, 0.9);
    cursor: pointer;
    width: 40px;
    height: 40px;
    margin-bottom: 0;
  }
}
.player-controls__item::before {
  content: "";
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: #fff;
  transform: scale(0.5);
  opacity: 0;
  box-shadow: 0px 5px 10px 0px rgba(76, 70, 124, 0.2);
  transition: all 0.3s ease-in-out;
  transition: all 0.4s cubic-bezier(0.35, 0.57, 0.13, 0.88);
}
@media screen and (min-width: 500px) {
  .player-controls__item:hover {
    color: #ffffff;
  }
  .player-controls__item:hover::before {
    opacity: 1;
    transform: scale(1.3);
  }
}
@media screen and (max-width: 576px), (max-height: 500px) {
  .player-controls__item:active {
    color: #ffffff;
  }
  .player-controls__item:active::before {
    opacity: 1;
    transform: scale(1.3);
  }
}
.player-controls__item .icon {
  position: relative;
  z-index: 2;
}
.player-controls__item.-xl {
  margin-bottom: 0;
  font-size: 95px;
  filter: drop-shadow(0 11px 6px rgba(172, 184, 204, 0.45));
  color: #fff;
  width: auto;
  height: auto;
  display: inline-flex;
}
@media screen and (max-width: 576px), (max-height: 500px) {
  .player-controls__item.-xl {
    margin-left: auto;
    font-size: 75px;
    margin-right: 0;
  }
}
.player-controls__item.-xl:before {
  display: none;
}
.player-controls__item.-favorite.active {
  color: #ff6b6b;
}

[v-cloak] {
  display: none;
}

[v-cloak] > * {
  display: none;
}

.progress {
  width: 100%;
  margin-top: -15px;
  user-select: none;
}
.progress__top {
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
}
.progress__duration {
  color: rgba(255, 255, 255, 0.8);
  font-weight: 700;
  font-size: 24px;
  opacity: 0.8;
}
.progress__time {
  margin-top: 2px;
  color: rgba(255, 255, 255, 0.8);
  font-weight: 700;
  font-size: 20px;
  opacity: 0.8;
}

.progress__bar {
  height: 8px;
  width: 100%;
  cursor: default;
  background-color: rgba(255, 255, 255, 0.2);
  display: inline-block;
  border-radius: 10px;
}

.progress__current {
  height: inherit;
  width: 0%;
  background: linear-gradient(90deg, #ff7eb3, #ff758c, #f9d423, #ff4e50, #43cea2, #185a9d);
  background-size: 400% 400%;
  animation: gradientShift 20s ease infinite;
  border-radius: 10px;
}

@keyframes gradientShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

.album-info {
  color: rgba(255, 255, 255, 0.9);
  flex: 1;
  padding-right: 60px;
  user-select: none;
}
@media screen and (max-width: 576px), (max-height: 500px) {
  .album-info {
    padding-right: 30px;
  }
}

/* bottom row under progress bar */
.progress__bottom {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.album-info__name {
  font-size: 26px;
  font-weight: bold;
  margin-bottom: 15px;
  line-height: 1.3em;
}
@media screen and (max-width: 576px), (max-height: 500px) {
  .album-info__name {
    font-size: 18px;
    margin-bottom: 9px;
  }
}
.album-info__track {
  font-weight: 400;
  font-size: 20px;
  opacity: 0.7;
  line-height: 1.3em;
  min-height: 52px;
}
@media screen and (max-width: 576px), (max-height: 500px) {
  .album-info__track {
    font-size: 18px;
    min-height: 50px;
  }
}

.album-info__artist {
  font-weight: 400;
  font-size: 16px;
  opacity: 0.8;
  line-height: 1.4em;
  margin-top: 8px;
  color: rgba(255, 255, 255, 0.85);
  display: flex;
  align-items: center;
  gap: 8px;
}
.album-info__artist i {
  font-size: 14px;
  opacity: 0.7;
}
@media screen and (max-width: 576px), (max-height: 500px) {
  .album-info__artist {
    font-size: 14px;
    margin-top: 6px;
  }
  .album-info__artist i {
    font-size: 12px;
  }
}

/* Volume control */
.volume {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 16px;
}
.volume__icon {
  border: none;
  background: none;
  color: rgba(255, 255, 255, 0.9);
  font-size: 18px;
  cursor: pointer;
  padding: 6px;
  border-radius: 50%;
  transition: transform 0.2s ease;
}
.volume__icon:hover { transform: scale(1.1); }
.volume__slider {
  -webkit-appearance: none;
  appearance: none;
  width: 100%;
  height: 8px;
  border-radius: 10px;
  background-color: rgba(255, 255, 255, 0.2);
  background-image: linear-gradient(90deg, #ff7eb3, #ff758c, #f9d423, #ff4e50, #43cea2, #185a9d);
  background-repeat: no-repeat;
  background-size: 0% 100%;
  cursor: pointer;
}
.volume__slider:focus { outline: none; }
.volume__slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #fff;
  box-shadow: 0px 5px 10px 0px rgba(76, 70, 124, 0.2);
  
}
.volume__slider::-moz-range-thumb {
  width: 18px;
  height: 18px;
  border: none;
  border-radius: 50%;
  background: #fff;
  box-shadow: 0px 5px 10px 0px rgba(76, 70, 124, 0.2);
}
.volume__value {
  min-width: 36px;
  text-align: right;
  color: rgba(255, 255, 255, 0.8);
  font-weight: 700;
  font-size: 14px;
  opacity: 0.8;
}

/* Visualizer wrapper and canvas for audio-reactive volume */
.volume__slider-wrap {
  position: relative;
  flex: 1;
  height: 50px;
  display: flex;
  align-items: center;
}
.volume__viz {
  position: absolute;
  left: 0;
  right: 0;
  height: 50px;
  
  pointer-events: none;
  z-index: 1;
}
/* Override slider background to be transparent; canvas will show visual */
.volume__slider {
  height: 50px;
  background: transparent !important;
  position: relative;
  z-index: 2;
}

/* Fullscreen button styling */
.fullscreen-btn {
  position: fixed;
  top: 12px;
  right: 16px;
  border: none;
  background: none;
  color: white;
  font-size: 24px;
  cursor: pointer;
  z-index: 1000;
  transition: all 0.3s ease;
  padding: 8px;
}

.fullscreen-btn:hover {
  transform: scale(1.1);
  color: cyan;
}

.fullscreen-btn:active {
  transform: scale(0.95);
}

/* Live count styling */
.live-count {
  position: fixed;
  top: 20px;
  left: 20px;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
  z-index: 1000;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.live-indicator {
  width: 8px;
  height: 8px;
  background-color: #43b581;
  border-radius: 50%;
  flex-shrink: 0;
}

.listeners-text {
  font-family: 'Bitter', serif;
  opacity: 0.85;
}

@media screen and (max-width: 576px), (max-height: 500px) {
  .fullscreen-btn {
    top: 10px;
    right: 12px;
    font-size: 22px;
  }
  .live-count {
    top: 12px;
    left: 12px;
    padding: 6px 12px;
    font-size: 13px;
  }
}

.github-btn {
  position: absolute;
  right: 40px;
  bottom: 50px;
  text-decoration: none;
  padding: 15px 25px;
  border-radius: 4px;
  box-shadow: 0px 4px 30px -6px rgba(36, 52, 70, 0.65);
  background: #24292e;
  color: #fff;
  font-weight: bold;
  letter-spacing: 1px;
  font-size: 16px;
  transition: all 0.3s ease-in-out;
}
@media screen and (min-width: 500px) {
  .github-btn:hover {
    transform: scale(1.1);
    box-shadow: 0px 17px 20px -6px rgba(36, 52, 70, 0.36);
  }
}
@media screen and (max-width: 700px) {
  .github-btn {
    position: relative;
    bottom: auto;
    right: auto;
    margin-top: 20px;
  }
  .github-btn:active {
    transform: scale(1.1);
    box-shadow: 0px 17px 20px -6px rgba(36, 52, 70, 0.36);
  }
}

.scale-out-enter-active {
  transition: all 0.35s ease-in-out;
}

.scale-out-leave-active {
  transition: all 0.35s ease-in-out;
}

.scale-out-enter {
  transform: scale(0.55);
  pointer-events: none;
  opacity: 0;
}

.scale-out-leave-to {
  transform: scale(1.2);
  pointer-events: none;
  opacity: 0;
}

.scale-in-enter-active {
  transition: all 0.35s ease-in-out;
}

.scale-in-leave-active {
  transition: all 0.35s ease-in-out;
}

.scale-in-enter {
  transform: scale(1.2);
  pointer-events: none;
  opacity: 0;
}

.scale-in-leave-to {
  transform: scale(0.55);
  pointer-events: none;
  opacity: 0;
}

/* Image transition classes for smooth album cover changes */
.cover-fade-enter-active {
  transition: opacity 0.5s ease-in-out;
}

.cover-fade-leave-active {
  transition: opacity 0.5s ease-in-out;
}

.cover-fade-enter {
  opacity: 0;
}

.cover-fade-leave-to {
  opacity: 1;
}

.cover-fade-enter-to {
  opacity: 1;
}

.cover-fade-leave {
  opacity: 1;
}

/* Search Container Styling */
.search-container {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1001;
  width: 90%;
  max-width: 500px;
}

.search-wrapper {
  position: relative;
  width: 100%;
}

.search-input-group {
  position: relative;
  display: flex;
  align-items: center;
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: 25px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: 
    0 8px 32px rgba(0, 0, 0, 0.1),
    0 4px 16px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
  overflow: hidden;
}

.search-input-group:focus-within {
  background: rgba(255, 255, 255, 0.25);
  border-color: rgba(255, 255, 255, 0.4);
  box-shadow: 
    0 12px 40px rgba(0, 0, 0, 0.15),
    0 6px 20px rgba(0, 0, 0, 0.15),
    0 0 0 3px rgba(255, 255, 255, 0.1);
  transform: translateY(-2px);
}

.search-icon {
  position: absolute;
  left: 18px;
  color: rgba(255, 255, 255, 0.8);
  font-size: 16px;
  pointer-events: none;
  transition: color 0.3s ease;
}

.search-input-group:focus-within .search-icon {
  color: rgba(255, 255, 255, 1);
}

.search-input {
  flex: 1;
  background: transparent;
  border: none;
  outline: none;
  color: white;
  font-size: 16px;
  padding: 16px 50px 16px 50px;
  font-family: 'Bitter', serif;
  transition: all 0.3s ease;
}

.search-input::placeholder {
  color: rgba(255, 255, 255, 0.6);
  transition: color 0.3s ease;
}

.search-input:focus::placeholder {
  color: rgba(255, 255, 255, 0.4);
}

.search-clear {
  position: absolute;
  right: 16px;
  background: none;
  border: none;
  color: rgba(255, 255, 255, 0.7);
  font-size: 14px;
  cursor: pointer;
  padding: 4px;
  border-radius: 50%;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
}

.search-clear:hover {
  color: white;
  background: rgba(255, 255, 255, 0.1);
  transform: scale(1.1);
}

/* Search Results Dropdown */
.search-results {
  position: absolute;
  top: calc(100% + 10px);
  left: 0;
  right: 0;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border-radius: 15px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: 
    0 20px 60px rgba(0, 0, 0, 0.2),
    0 8px 32px rgba(0, 0, 0, 0.1);
  overflow: hidden;
  animation: slideDown 0.3s ease-out;
  max-height: 400px;
  overflow-y: auto;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.search-results-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  background: rgba(255, 255, 255, 0.05);
}

.results-count {
  color: rgba(255, 255, 255, 0.8);
  font-size: 14px;
  font-weight: 600;
  font-family: 'Bitter', serif;
}

.close-results {
  background: none;
  border: none;
  color: rgba(255, 255, 255, 0.6);
  font-size: 14px;
  cursor: pointer;
  padding: 4px;
  border-radius: 50%;
  transition: all 0.3s ease;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-results:hover {
  color: white;
  background: rgba(255, 255, 255, 0.1);
}

.search-results-list {
  padding: 8px 0;
}

.search-result-item {
  display: flex;
  align-items: center;
  padding: 12px 20px;
  cursor: pointer;
  transition: all 0.3s ease;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  position: relative;
}

.search-result-item:hover {
  background: rgba(255, 255, 255, 0.1);
  transform: translateX(5px);
}

.search-result-item.playing {
  background: rgba(255, 255, 255, 0.15);
  border-left: 3px solid #43b581;
}

.search-result-item:last-child {
  border-bottom: none;
}

.result-album-art {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  overflow: hidden;
  margin-right: 15px;
  flex-shrink: 0;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.result-album-art img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.search-result-item:hover .result-album-art img {
  transform: scale(1.1);
}

.result-info {
  flex: 1;
  min-width: 0;
}

.result-title {
  color: white;
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-family: 'Bitter', serif;
}

.result-artist {
  color: rgba(255, 255, 255, 0.7);
  font-size: 13px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.result-actions {
  margin-left: 15px;
}

.play-result-btn {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
}

.play-result-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: scale(1.1);
}

/* Responsive Design for Search */
@media screen and (max-width: 576px) {
  .search-container {
    top: 15px;
    width: 95%;
    max-width: none;
  }
  
  .search-input {
    font-size: 15px;
    padding: 14px 45px 14px 45px;
  }
  
  .search-icon {
    left: 16px;
    font-size: 15px;
  }
  
  .search-clear {
    right: 14px;
    width: 22px;
    height: 22px;
  }
  
  .search-results {
    max-height: 350px;
  }
  
  .result-album-art {
    width: 35px;
    height: 35px;
    margin-right: 12px;
  }
  
  .result-title {
    font-size: 14px;
  }
  
  .result-artist {
    font-size: 12px;
  }
  
  .play-result-btn {
    width: 28px;
    height: 28px;
    font-size: 11px;
  }
}

@media screen and (max-height: 500px) {
  .search-container {
    top: 10px;
  }
  
  .search-results {
    max-height: 300px;
  }
}

    </style>
</head>

<body>
    <button id="fullscreen-toggle" class="fullscreen-btn" title="Toggle Fullscreen">
        <i class="fa-solid fa-expand"></i>
    </button>

    <div class="live-count">
        <div class="live-indicator"></div>
        <span id="livecount">0</span>
        <span class="listeners-text">listeners</span>
    </div>

    <div class="background">
        <img src="" id="bg-img">
    </div>

    <div class="wrapper" id="app">
        <!-- Search Bar -->
        <div class="search-container">
            <div class="search-wrapper">
                <div class="search-input-group">
                    <i class="fa-solid fa-search search-icon"></i>
                    <input 
                        type="text" 
                        class="search-input" 
                        placeholder="Search for titles "
                        v-model="searchQuery"
                        @input="performSearch"
                        @focus="showSearchResults = true"
                        @blur="handleSearchBlur"
                        @keydown.enter="handleSearchEnter"
                        @keydown.escape="clearSearch"
                    >
                    <button 
                        v-if="searchQuery" 
                        class="search-clear" 
                        @click="clearSearch"
                        title="Clear search"
                    >
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
                
                <!-- Search Results Dropdown -->
                <div class="search-results" v-if="showSearchResults && filteredTracks.length > 0">
                    <div class="search-results-header">
                        <span class="results-count">{{ filteredTracks.length }} result{{ filteredTracks.length !== 1 ? 's' : '' }}</span>
                        <button class="close-results" @click="showSearchResults = false">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                    <div class="search-results-list">
                        <div 
                            v-for="(track, index) in filteredTracks.slice(0, 8)" 
                            :key="index"
                            class="search-result-item"
                            @click="playSearchResult(track, index)"
                            :class="{ 'playing': currentTrack && currentTrack.name === track.title }"
                        >
                            <div class="result-album-art">
                                <img :src="track.cover || getFallbackAlbumArt()" :alt="track.title" @error="handleImageError">
                            </div>
                            <div class="result-info">
                                <div class="result-title">{{ track.title }}</div>
                                
                            </div>
                            <div class="result-actions">
                                <button class="play-result-btn" @click.stop="playSearchResult(track, index)" title="Play this track">
                                    <i class="fa-solid fa-play"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="player">
            <div class="player__top">
                <div class="player-cover">
                    <transition name="cover-fade" mode="out-in">
                        <div class="player-cover__item" v-if="currentTrack" :key="currentTrack.id || currentTrack.name"
                            :style="{ backgroundImage: `url(${currentTrack.cover})` }"></div>
                    </transition>
                </div>
                <div class="player-controls">
                    <div class="player-controls__item -favorite" :class="{ active : currentTrack.favorited }"
                        @click="favorite">
                        <svg class="icon">
                            <use xlink:href="#icon-heart-o"></use>
                        </svg>
                    </div>
                    <a :href="`https://open.spotify.com/search/${encodeURIComponent(currentTrack.name)}`" target="_blank" class="player-controls__item" title="Open on Spotify" aria-label="Open on Spotify">
                        <i class="fa-brands fa-spotify"></i>
                    </a>
                    <div class="player-controls__item" @click="prevTrack">
                        <svg class="icon">
                            <use xlink:href="#icon-prev"></use>
                        </svg>
                    </div>
                    <div class="player-controls__item" @click="nextTrack">
                        <svg class="icon">
                            <use xlink:href="#icon-next"></use>
                        </svg>
                    </div>
                    <div class="player-controls__item -xl js-play" @click="play">
                        <svg class="icon">
                            <use xlink:href="#icon-pause" v-if="isTimerPlaying"></use>
                            <use xlink:href="#icon-play" v-else></use>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="progress" ref="progress">
                <div class="progress__top">
                    <div class="album-info" v-if="currentTrack">
                        <div class="album-info__name">{{ currentTrack.name }}</div>
                        <div class="album-info__artist" v-if="currentTrack.contributingArtists">
                            <i class="fa-solid fa-users"></i> {{ currentTrack.contributingArtists }}
                        </div>
                    </div>
                </div>
                <!--
                <div class="progress__bar">
                    <div class="progress__current" :style="{ width : barWidth }"></div>
                </div>
                <div class="progress__bottom">
                    <div class="progress__time">{{ currentTime }}</div>
                    <div class="progress__duration">{{ duration }}</div>
                </div>
                -->
                <!-- Volume control -->
                <div class="volume">
                    <button class="volume__icon" @click="toggleMute" :title="isMuted ? 'Unmute' : 'Mute'">
                        <i :class="isMuted || volume === 0 ? 'fa-solid fa-volume-xmark' : (volume < 0.5 ? 'fa-solid fa-volume-low' : 'fa-solid fa-volume-high')"></i>
                    </button>
                    <div class="volume__slider-wrap">
                        <canvas ref="volumeViz" class="volume__viz"></canvas>
                        <input
                            class="volume__slider"
                            type="range"
                            min="0" max="1" step="0.01"
                            :value="volume"
                            @input="onVolumeInput($event)"
                            aria-label="Volume"
                        />
                    </div>
                    <div class="volume__value">{{ Math.round(volume * 100) }}%</div>
                </div>
            </div>
            <div v-cloak></div>
        </div>
      
    </div>

    <svg xmlns="http://www.w3.org/2000/svg" hidden xmlns:xlink="http://www.w3.org/1999/xlink">
        <defs>
            <symbol id="icon-heart-o" viewBox="0 0 32 32">
                <title>icon-heart-o</title>
                <path
                    d="M22.88 1.952c-2.72 0-5.184 1.28-6.88 3.456-1.696-2.176-4.16-3.456-6.88-3.456-4.48 0-9.024 3.648-9.024 10.592 0 7.232 7.776 12.704 15.072 17.248 0.256 0.16 0.544 0.256 0.832 0.256s0.576-0.096 0.832-0.256c7.296-4.544 15.072-10.016 15.072-17.248 0-6.944-4.544-10.592-9.024-10.592zM16 26.56c-4.864-3.072-12.736-8.288-12.736-14.016 0-5.088 3.040-7.424 5.824-7.424 2.368 0 4.384 1.504 5.408 4.032 0.256 0.608 0.832 0.992 1.472 0.992s1.248-0.384 1.472-0.992c1.024-2.528 3.040-4.032 5.408-4.032 2.816 0 5.824 2.304 5.824 7.424 0.064 5.728-7.808 10.976-12.672 14.016z">
                </path>
                <path
                    d="M16 30.144c-0.32 0-0.64-0.096-0.896-0.256-7.296-4.576-15.104-10.048-15.104-17.344 0-7.008 4.576-10.688 9.12-10.688 2.656 0 5.152 1.216 6.88 3.392 1.728-2.144 4.224-3.392 6.88-3.392 4.544 0 9.12 3.68 9.12 10.688 0 7.296-7.808 12.768-15.104 17.344-0.256 0.16-0.576 0.256-0.896 0.256zM9.12 2.048c-4.448 0-8.928 3.616-8.928 10.496 0 7.168 7.744 12.64 15.008 17.152 0.48 0.288 1.12 0.288 1.568 0 7.264-4.544 15.008-9.984 15.008-17.152 0-6.88-4.48-10.496-8.928-10.496-2.656 0-5.088 1.216-6.816 3.392l-0.032 0.128-0.064-0.096c-1.696-2.176-4.192-3.424-6.816-3.424zM16 26.688l-0.064-0.032c-3.808-2.4-12.768-8.032-12.768-14.112 0-5.152 3.072-7.52 5.952-7.52 2.432 0 4.48 1.536 5.504 4.096 0.224 0.576 0.768 0.928 1.376 0.928s1.152-0.384 1.376-0.928c1.024-2.56 3.072-4.096 5.504-4.096 2.848 0 5.952 2.336 5.952 7.52 0 6.080-8.96 11.712-12.768 14.112l-0.064 0.032zM9.12 5.248c-2.752 0-5.728 2.304-5.728 7.328 0 5.952 8.8 11.488 12.608 13.92 3.808-2.4 12.608-7.968 12.608-13.92 0-5.024-2.976-7.328-5.728-7.328-2.336 0-4.32 1.472-5.312 3.968-0.256 0.64-0.864 1.056-1.568 1.056s-1.312-0.416-1.568-1.056c-0.992-2.496-2.976-3.968-5.312-3.968z">
                </path>
                <path
                    d="M6.816 20.704c0.384 0.288 0.512 0.704 0.48 1.12 0.224 0.256 0.384 0.608 0.384 0.96 0 0.032 0 0.032 0 0.064 0.16 0.128 0.32 0.256 0.48 0.384 0.128 0.064 0.256 0.16 0.384 0.256 0.096 0.064 0.192 0.16 0.256 0.224 0.8 0.576 1.632 1.12 2.496 1.664 0.416 0.128 0.8 0.256 1.056 0.32 1.984 0.576 4.064 0.8 6.112 0.928 2.688-1.92 5.312-3.904 8-5.792 0.896-1.088 1.92-2.080 2.912-3.104v-7.552c-0.096-0.128-0.192-0.288-0.32-0.416-0.768-1.024-1.184-2.176-1.6-3.296-0.768-0.416-1.536-0.8-2.336-1.12-0.128-0.064-0.256-0.096-0.384-0.16h-21.568v12.992c1.312 0.672 2.496 1.6 3.648 2.528z">
                </path>
            </symbol>
            <symbol id="icon-heart" viewBox="0 0 32 32">
                <title>icon-heart</title>
                <path
                    d="M22.88 1.952c-2.72 0-5.184 1.28-6.88 3.456-1.696-2.176-4.16-3.456-6.88-3.456-4.48 0-9.024 3.648-9.024 10.592 0 7.232 7.776 12.704 15.072 17.248 0.256 0.16 0.544 0.256 0.832 0.256s0.576-0.096 0.832-0.256c7.296-4.544 15.072-10.016 15.072-17.248 0-6.944-4.544-10.592-9.024-10.592zM16 26.56c-4.864-3.072-12.736-8.288-12.736-14.016 0-5.088 3.040-7.424 5.824-7.424 2.368 0 4.384 1.504 5.408 4.032 0.256 0.608 0.832 0.992 1.472 0.992s1.248-0.384 1.472-0.992c1.024-2.528 3.040-4.032 5.408-4.032 2.816 0 5.824 2.304 5.824 7.424 0.064 5.728-7.808 10.976-12.672 14.016z">
                </path>
                <path
                    d="M16 30.144c-0.32 0-0.64-0.096-0.896-0.256-7.296-4.576-15.104-10.048-15.104-17.344 0-7.008 4.576-10.688 9.12-10.688 2.656 0 5.152 1.216 6.88 3.392 1.728-2.144 4.224-3.392 6.88-3.392 4.544 0 9.12 3.68 9.12 10.688 0 7.296-7.808 12.768-15.104 17.344-0.256 0.16-0.576 0.256-0.896 0.256zM9.12 2.048c-4.448 0-8.928 3.616-8.928 10.496 0 7.168 7.744 12.64 15.008 17.152 0.48 0.288 1.12 0.288 1.568 0 7.264-4.544 15.008-9.984 15.008-17.152 0-6.88-4.48-10.496-8.928-10.496-2.656 0-5.088 1.216-6.816 3.392l-0.032 0.128-0.064-0.096c-1.696-2.176-4.192-3.424-6.816-3.424zM16 26.688l-0.064-0.032c-3.808-2.4-12.768-8.032-12.768-14.112 0-5.152 3.072-7.52 5.952-7.52 2.432 0 4.48 1.536 5.504 4.096 0.224 0.576 0.768 0.928 1.376 0.928s1.152-0.384 1.376-0.928c1.024-2.56 3.072-4.096 5.504-4.096 2.848 0 5.952 2.336 5.952 7.52 0 6.080-8.96 11.712-12.768 14.112l-0.064 0.032zM9.12 5.248c-2.752 0-5.728 2.304-5.728 7.328 0 5.952 8.8 11.488 12.608 13.92 3.808-2.4 12.608-7.968 12.608-13.92 0-5.024-2.976-7.328-5.728-7.328-2.336 0-4.32 1.472-5.312 3.968-0.256 0.64-0.864 1.056-1.568 1.056s-1.312-0.416-1.568-1.056c-0.992-2.496-2.976-3.968-5.312-3.968z">
                </path>
            </symbol>
            <symbol id="icon-infinity" viewBox="0 0 32 32">
                <title>icon-infinity</title>
                <path
                    d="M29.312 20.832c-1.28 1.28-3.008 1.984-4.832 1.984s-3.52-0.704-4.832-1.984c-0.032-0.032-0.224-0.224-0.256-0.256v0 1.28c0 0.448-0.352 0.8-0.8 0.8s-0.8-0.352-0.8-0.8v-3.168c0-0.448 0.352-0.8 0.8-0.8h3.168c0.448 0 0.8 0.352 0.8 0.8s-0.352 0.8-0.8 0.8h-1.28c0.032 0.032 0.224 0.224 0.256 0.256 0.992 0.992 2.304 1.536 3.68 1.536 1.408 0 2.72-0.544 3.68-1.536 0.992-0.992 1.536-2.304 1.536-3.68s-0.544-2.72-1.536-3.68c-0.992-0.992-2.304-1.536-3.68-1.536-1.408 0-2.72 0.544-3.68 1.536l-8.416 8.448c-1.312 1.312-3.072 1.984-4.832 1.984s-3.488-0.672-4.832-1.984c-2.656-2.656-2.656-6.976 0-9.632s6.976-2.656 9.632 0c0.032 0.032 0.16 0.16 0.192 0.192l0.064 0.064v-1.28c0-0.448 0.352-0.8 0.8-0.8s0.8 0.352 0.8 0.8v3.168c0 0.448-0.352 0.8-0.8 0.8h-3.168c-0.448 0-0.8-0.352-0.8-0.8s0.352-0.8 0.8-0.8h1.28l-0.096-0.064c-0.032-0.032-0.16-0.16-0.192-0.192-0.992-0.992-2.304-1.536-3.68-1.536s-2.72 0.544-3.68 1.536c-2.048 2.048-2.048 5.344 0 7.392 0.992 0.992 2.304 1.536 3.68 1.536s2.72-0.544 3.68-1.536l8.512-8.512c1.28-1.28 3.008-1.984 4.832-1.984s3.52 0.704 4.832 1.984c2.624 2.656 2.624 7.008-0.032 9.664z">
                </path>
                <path
                    d="M24.512 23.488c-1.6 0-3.136-0.512-4.416-1.44-0.128 0.704-0.736 1.248-1.44 1.248-0.8 0-1.472-0.672-1.472-1.472v-3.168c0-0.8 0.672-1.472 1.472-1.472h3.168c0.8 0 1.472 0.672 1.472 1.472 0 0.608-0.384 1.152-0.928 1.376 0.64 0.352 1.376 0.544 2.144 0.544 1.216 0 2.368-0.48 3.2-1.344 0.864-0.864 1.344-1.984 1.344-3.2s-0.48-2.368-1.344-3.2c-0.864-0.864-1.984-1.344-3.2-1.344s-2.368 0.48-3.2 1.344l-8.512 8.48c-1.408 1.408-3.296 2.176-5.312 2.176s-3.872-0.768-5.312-2.176c-2.912-2.912-2.912-7.68 0-10.592 1.408-1.408 3.296-2.176 5.312-2.176 0 0 0 0 0 0 1.6 0 3.136 0.512 4.416 1.44 0.128-0.704 0.736-1.248 1.472-1.248 0.8 0 1.472 0.672 1.472 1.472v3.168c0 0.8-0.672 1.472-1.472 1.472h-3.168c-0.8 0-1.472-0.672-1.472-1.472 0-0.608 0.384-1.152 0.928-1.376-0.64-0.352-1.376-0.544-2.144-0.544-1.216 0-2.368 0.48-3.2 1.344-1.76 1.76-1.76 4.64 0 6.432 0.864 0.864 2.016 1.344 3.2 1.344 1.216 0 2.368-0.48 3.2-1.344l8.48-8.544c1.408-1.408 3.296-2.208 5.312-2.208s3.872 0.768 5.312 2.208c1.408 1.408 2.176 3.296 2.176 5.312s-0.768 3.872-2.208 5.312v0c0 0 0 0 0 0-1.408 1.408-3.296 2.176-5.28 2.176zM18.752 18.912l1.44 1.44c1.152 1.152 2.688 1.792 4.32 1.792s3.168-0.64 4.32-1.792v0c1.152-1.152 1.792-2.688 1.792-4.32s-0.64-3.168-1.792-4.32c-1.152-1.152-2.688-1.792-4.352-1.792-1.632 0-3.168 0.64-4.32 1.792l-8.48 8.448c-1.12 1.12-2.592 1.728-4.16 1.728s-3.072-0.608-4.16-1.728c-2.304-2.304-2.304-6.048 0-8.352 1.12-1.12 2.592-1.728 4.16-1.728s3.072 0.608 4.16 1.728l1.44 1.408h-2.912c-0.064 0-0.128 0.064-0.128 0.128s0.064 0.128 0.128 0.128h3.168c0.064 0 0.128-0.064 0.128-0.128v-3.168c0-0.064-0.064-0.128-0.128-0.128s-0.128 0.064-0.128 0.128v2.912l-1.408-1.408c-1.152-1.152-2.688-1.792-4.352-1.792-1.632 0-3.168 0.64-4.32 1.792-2.4 2.4-2.4 6.272 0 8.672 1.152 1.152 2.688 1.792 4.32 1.792s3.168-0.64 4.32-1.792l8.512-8.512c1.12-1.12 2.592-1.728 4.16-1.728s3.072 0.608 4.16 1.728c1.12 1.12 1.728 2.592 1.728 4.16s-0.608 3.072-1.728 4.16c-1.12 1.12-2.592 1.728-4.16 1.728s-3.072-0.608-4.16-1.728l-1.408-1.408h2.912c0.064 0 0.128-0.064 0.128-0.128s-0.064-0.128-0.128-0.128h-3.168c-0.064 0-0.128 0.064-0.128 0.128v3.168c0 0.064 0.064 0.128 0.128 0.128s0.128-0.064 0.128-0.128v-2.88z">
                </path>
            </symbol>
            <symbol id="icon-pause" viewBox="0 0 32 32">
                <title>icon-pause</title>
                <path
                    d="M16 0.32c-8.64 0-15.68 7.040-15.68 15.68s7.040 15.68 15.68 15.68 15.68-7.040 15.68-15.68-7.040-15.68-15.68-15.68zM16 29.216c-7.296 0-13.216-5.92-13.216-13.216s5.92-13.216 13.216-13.216 13.216 5.92 13.216 13.216-5.92 13.216-13.216 13.216z">
                </path>
                <path
                    d="M16 32c-8.832 0-16-7.168-16-16s7.168-16 16-16 16 7.168 16 16-7.168 16-16 16zM16 0.672c-8.448 0-15.328 6.88-15.328 15.328s6.88 15.328 15.328 15.328c8.448 0 15.328-6.88 15.328-15.328s-6.88-15.328-15.328-15.328zM16 29.568c-7.488 0-13.568-6.080-13.568-13.568s6.080-13.568 13.568-13.568c7.488 0 13.568 6.080 13.568 13.568s-6.080 13.568-13.568 13.568zM16 3.104c-7.104 0-12.896 5.792-12.896 12.896s5.792 12.896 12.896 12.896c7.104 0 12.896-5.792 12.896-12.896s-5.792-12.896-12.896-12.896z">
                </path>
                <path
                    d="M12.16 22.336v0c-0.896 0-1.6-0.704-1.6-1.6v-9.472c0-0.896 0.704-1.6 1.6-1.6v0c0.896 0 1.6 0.704 1.6 1.6v9.504c0 0.864-0.704 1.568-1.6 1.568z">
                </path>
                <path
                    d="M19.84 22.336v0c-0.896 0-1.6-0.704-1.6-1.6v-9.472c0-0.896 0.704-1.6 1.6-1.6v0c0.896 0 1.6 0.704 1.6 1.6v9.504c0 0.864-0.704 1.568-1.6 1.568z">
                </path>
            </symbol>
            <symbol id="icon-play" viewBox="0 0 32 32">
                <title>icon-play</title>
                <path
                    d="M21.216 15.168l-7.616-5.088c-0.672-0.416-1.504 0.032-1.504 0.832v10.176c0 0.8 0.896 1.248 1.504 0.832l7.616-5.088c0.576-0.416 0.576-1.248 0-1.664z">
                </path>
                <path
                    d="M13.056 22.4c-0.224 0-0.416-0.064-0.608-0.16-0.448-0.224-0.704-0.672-0.704-1.152v-10.176c0-0.48 0.256-0.928 0.672-1.152s0.928-0.224 1.344 0.064l7.616 5.088c0.384 0.256 0.608 0.672 0.608 1.088s-0.224 0.864-0.608 1.088l-7.616 5.088c-0.192 0.16-0.448 0.224-0.704 0.224zM13.056 10.272c-0.096 0-0.224 0.032-0.32 0.064-0.224 0.128-0.352 0.32-0.352 0.576v10.176c0 0.256 0.128 0.48 0.352 0.576 0.224 0.128 0.448 0.096 0.64-0.032l7.616-5.088c0.192-0.128 0.288-0.32 0.288-0.544s-0.096-0.416-0.288-0.544l-7.584-5.088c-0.096-0.064-0.224-0.096-0.352-0.096z">
                </path>
                <path
                    d="M16 0.32c-8.64 0-15.68 7.040-15.68 15.68s7.040 15.68 15.68 15.68 15.68-7.040 15.68-15.68-7.040-15.68-15.68-15.68zM16 29.216c-7.296 0-13.216-5.92-13.216-13.216s5.92-13.216 13.216-13.216 13.216 5.92 13.216 13.216-5.92 13.216-13.216 13.216z">
                </path>
                <path
                    d="M16 32c-8.832 0-16-7.168-16-16s7.168-16 16-16 16 7.168 16 16-7.168 16-16 16zM16 0.672c-8.448 0-15.328 6.88-15.328 15.328s6.88 15.328 15.328 15.328c8.448 0 15.328-6.88 15.328-15.328s-6.88-15.328-15.328-15.328zM16 29.568c-7.488 0-13.568-6.080-13.568-13.568s6.080-13.568 13.568-13.568c7.488 0 13.568 6.080 13.568 13.568s-6.080 13.568-13.568 13.568zM16 3.104c-7.104 0-12.896 5.792-12.896 12.896s5.792 12.896 12.896 12.896c7.104 0 12.896-5.792 12.896-12.896s-5.792-12.896-12.896-12.896z">
                </path>
            </symbol>
            <symbol id="icon-link" viewBox="0 0 32 32">
                <title>link</title>
                <path
                    d="M23.584 17.92c0 0.864 0 1.728 0 2.56 0 1.312 0 2.656 0 3.968 0 0.352 0.032 0.736-0.032 1.12 0.032-0.16 0.032-0.288 0.064-0.448-0.032 0.224-0.096 0.448-0.16 0.64 0.064-0.128 0.128-0.256 0.16-0.416-0.096 0.192-0.192 0.384-0.32 0.576 0.096-0.128 0.16-0.224 0.256-0.352-0.128 0.16-0.288 0.32-0.48 0.48 0.128-0.096 0.224-0.16 0.352-0.256-0.192 0.128-0.352 0.256-0.576 0.32 0.128-0.064 0.256-0.128 0.416-0.16-0.224 0.096-0.416 0.16-0.64 0.16 0.16-0.032 0.288-0.032 0.448-0.064-0.256 0.032-0.512 0.032-0.768 0.032-0.448 0-0.896 0-1.312 0-1.472 0-2.976 0-4.448 0-1.824 0-3.616 0-5.44 0-1.568 0-3.104 0-4.672 0-0.736 0-1.44 0-2.176 0-0.128 0-0.224 0-0.352-0.032 0.16 0.032 0.288 0.032 0.448 0.064-0.224-0.032-0.448-0.096-0.64-0.16 0.128 0.064 0.256 0.128 0.416 0.16-0.192-0.096-0.384-0.192-0.576-0.32 0.128 0.096 0.224 0.16 0.352 0.256-0.16-0.128-0.32-0.288-0.48-0.48 0.096 0.128 0.16 0.224 0.256 0.352-0.128-0.192-0.256-0.352-0.32-0.576 0.064 0.128 0.128 0.256 0.16 0.416-0.096-0.224-0.16-0.416-0.16-0.64 0.032 0.16 0.032 0.288 0.064 0.448-0.032-0.256-0.032-0.512-0.032-0.768 0-0.448 0-0.896 0-1.312 0-1.472 0-2.976 0-4.448 0-1.824 0-3.616 0-5.44 0-1.568 0-3.104 0-4.672 0-0.736 0-1.44 0-2.176 0-0.128 0-0.224 0.032-0.352-0.032 0.16-0.032 0.288-0.064 0.448 0.032-0.224 0.096-0.448 0.16-0.64-0.064 0.128-0.128 0.256-0.16 0.416 0.096-0.192 0.192-0.384 0.32-0.576-0.096 0.128-0.16 0.224-0.256 0.352 0.128-0.16 0.288-0.32 0.48-0.48-0.128 0.096-0.224 0.16-0.352 0.256 0.192-0.128 0.352-0.256 0.576-0.32-0.128 0.064-0.256 0.128-0.416 0.16 0.224-0.096 0.416-0.16 0.64-0.16-0.16 0.032-0.288 0.032-0.448 0.064 0.48-0.064 0.96-0.032 1.44-0.032 0.992 0 1.952 0 2.944 0 1.216 0 2.432 0 3.616 0 1.056 0 2.112 0 3.168 0 0.512 0 1.024 0 1.536 0 0 0 0 0 0.032 0 0.448 0 0.896-0.192 1.184-0.48s0.512-0.768 0.48-1.184c-0.032-0.448-0.16-0.896-0.48-1.184s-0.736-0.48-1.184-0.48c-0.64 0-1.28 0-1.92 0-1.408 0-2.816 0-4.224 0-1.44 0-2.848 0-4.256 0-0.672 0-1.344 0-2.016 0-0.736 0-1.472 0.192-2.112 0.576s-1.216 0.96-1.568 1.6c-0.384 0.64-0.544 1.376-0.544 2.144 0 0.672 0 1.376 0 2.048 0 1.28 0 2.56 0 3.84 0 1.504 0 3.040 0 4.544 0 1.408 0 2.848 0 4.256 0 0.992 0 1.952 0 2.944 0 0.224 0 0.448 0 0.64 0 0.864 0.224 1.76 0.768 2.464 0.16 0.192 0.288 0.384 0.48 0.576s0.384 0.352 0.608 0.512c0.32 0.224 0.64 0.384 1.024 0.512 0.448 0.16 0.928 0.224 1.408 0.224 0.16 0 0.32 0 0.48 0 0.896 0 1.792 0 2.72 0 1.376 0 2.784 0 4.16 0 1.536 0 3.040 0 4.576 0 1.312 0 2.656 0 3.968 0 0.768 0 1.536 0 2.336 0 0.416 0 0.832-0.032 1.248-0.128 1.504-0.32 2.784-1.6 3.104-3.104 0.128-0.544 0.128-1.056 0.128-1.568 0-0.608 0-1.184 0-1.792 0-1.408 0-2.816 0-4.224 0-0.256 0-0.512 0-0.768 0-0.448-0.192-0.896-0.48-1.184s-0.768-0.512-1.184-0.48c-0.448 0.032-0.896 0.16-1.184 0.48-0.384 0.384-0.576 0.768-0.576 1.248v0z">
                </path>
                <path
                    d="M32 11.232c0-0.8 0-1.568 0-2.368 0-1.248 0-2.528 0-3.776 0-0.288 0-0.576 0-0.864 0-0.896-0.768-1.696-1.696-1.696-0.8 0-1.568 0-2.368 0-1.248 0-2.528 0-3.776 0-0.288 0-0.576 0-0.864 0-0.448 0-0.896 0.192-1.184 0.48s-0.512 0.768-0.48 1.184c0.032 0.448 0.16 0.896 0.48 1.184s0.736 0.48 1.184 0.48c0.8 0 1.568 0 2.368 0 1.248 0 2.528 0 3.776 0 0.288 0 0.576 0 0.864 0-0.576-0.576-1.12-1.12-1.696-1.696 0 0.8 0 1.568 0 2.368 0 1.248 0 2.528 0 3.776 0 0.288 0 0.576 0 0.864 0 0.448 0.192 0.896 0.48 1.184s0.768 0.512 1.184 0.48c0.448-0.032 0.896-0.16 1.184-0.48 0.352-0.256 0.544-0.64 0.544-1.12v0z">
                </path>
                <path
                    d="M15.040 21.888c0.16-0.16 0.288-0.288 0.448-0.448 0.384-0.384 0.8-0.8 1.184-1.184 0.608-0.608 1.184-1.184 1.792-1.792 0.704-0.704 1.44-1.44 2.176-2.176 0.8-0.8 1.568-1.568 2.368-2.368s1.6-1.6 2.4-2.4c0.736-0.736 1.504-1.504 2.24-2.24 0.64-0.64 1.248-1.248 1.888-1.888 0.448-0.448 0.896-0.896 1.344-1.344 0.224-0.224 0.448-0.416 0.64-0.64 0 0 0.032-0.032 0.032-0.032 0.32-0.32 0.48-0.768 0.48-1.184s-0.192-0.896-0.48-1.184c-0.32-0.288-0.736-0.512-1.184-0.48-0.512 0.032-0.928 0.16-1.248 0.48-0.16 0.16-0.288 0.288-0.448 0.448-0.384 0.384-0.8 0.8-1.184 1.184-0.608 0.608-1.184 1.184-1.792 1.792-0.704 0.704-1.44 1.44-2.176 2.176-0.8 0.8-1.568 1.568-2.368 2.368s-1.6 1.6-2.4 2.4c-0.736 0.736-1.504 1.504-2.24 2.24-0.64 0.64-1.248 1.248-1.888 1.888-0.448 0.448-0.896 0.896-1.344 1.344-0.224 0.224-0.448 0.416-0.64 0.64 0 0-0.032 0.032-0.032 0.032-0.32 0.32-0.48 0.768-0.48 1.184s0.192 0.896 0.48 1.184c0.32 0.288 0.736 0.512 1.184 0.48 0.48 0 0.928-0.16 1.248-0.48v0z">
                </path>
            </symbol>
            <symbol id="icon-next" viewBox="0 0 32 32">
                <title>next</title>
                <path
                    d="M2.304 18.304h14.688l-4.608 4.576c-0.864 0.864-0.864 2.336 0 3.232 0.864 0.864 2.336 0.864 3.232 0l8.448-8.48c0.864-0.864 0.864-2.336 0-3.232l-8.448-8.448c-0.448-0.448-1.056-0.672-1.632-0.672s-1.184 0.224-1.632 0.672c-0.864 0.864-0.864 2.336 0 3.232l4.64 4.576h-14.688c-1.248 0-2.304 0.992-2.304 2.272s1.024 2.272 2.304 2.272z">
                </path>
                <path
                    d="M29.696 26.752c1.248 0 2.304-1.024 2.304-2.304v-16.928c0-1.248-1.024-2.304-2.304-2.304s-2.304 1.024-2.304 2.304v16.928c0.064 1.28 1.056 2.304 2.304 2.304z">
                </path>
            </symbol>
            <symbol id="icon-prev" viewBox="0 0 32 32">
                <title>prev</title>
                <path
                    d="M29.696 13.696h-14.688l4.576-4.576c0.864-0.864 0.864-2.336 0-3.232-0.864-0.864-2.336-0.864-3.232 0l-8.448 8.48c-0.864 0.864-0.864 2.336 0 3.232l8.448 8.448c0.448 0.448 1.056 0.672 1.632 0.672s1.184-0.224 1.632-0.672c0.864-0.864 0.864-2.336 0-3.232l-4.608-4.576h14.688c1.248 0 2.304-1.024 2.304-2.304s-1.024-2.24-2.304-2.24z">
                </path>
                <path
                    d="M2.304 5.248c-1.248 0-2.304 1.024-2.304 2.304v16.928c0 1.248 1.024 2.304 2.304 2.304s2.304-1.024 2.304-2.304v-16.928c-0.064-1.28-1.056-2.304-2.304-2.304z">
                </path>
            </symbol>
        </defs>
    </svg>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.10/vue.min.js"></script>

    
    <script>
    // Firebase configuration and live count functionality
    const firebaseConfig = {
        apiKey: "AIzaSyBgWvYqf2pv2iCyMe8Ui7BKrVjGHXGoSfI",
        authDomain: "livecountupdate.firebaseapp.com",
        databaseURL: "https://livecountupdate-default-rtdb.firebaseio.com",
        projectId: "livecountupdate",
        storageBucket: "livecountupdate.firebasestorage.app",
        messagingSenderId: "392205412851",
        appId: "1:392205412851:web:3734f056ed22322ff7ca86"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Safe room name based on page path
    const room = (location.pathname || "/")
      .replace(/\//g, "_")            // replace slashes with underscores
      .replace(/[.#$\[\]]/g, "_")     // remove illegal Firebase chars
      || "_root";

    // Reference to the room's viewers node
    const viewersRef = db.ref("viewers/" + room);

    // Create a unique id for this visitor
    const myId = Date.now().toString() + "_" + Math.random().toString(36).substr(2, 9);

    // Add self to viewers list
    viewersRef.child(myId).set({ ts: firebase.database.ServerValue.TIMESTAMP })
      .catch(err => console.error("Add viewer failed:", err));

    // Remove on disconnect
    viewersRef.child(myId).onDisconnect().remove();

    // Listen for changes and update count
    viewersRef.on("value", snapshot => {
      const cnt = snapshot ? snapshot.numChildren() : 0;
      document.getElementById("livecount").innerText = cnt;
    });

    // Optional: cleanup stale entries (in case onDisconnect fails)
    setInterval(async () => {
      try {
        const snap = await viewersRef.once("value");
        const now = Date.now();
        snap.forEach(child => {
          const val = child.val();
          if (val && val.ts && (now - val.ts) > (1000 * 60 * 10)) {
            viewersRef.child(child.key).remove().catch(()=>{});
          }
        });
      } catch (e) { /* ignore cleanup errors */ }
    }, 1000 * 60 * 5); // every 5 minutes

    // Fullscreen functionality
    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
            document.querySelector('.fullscreen-btn i').classList.replace('fa-expand', 'fa-compress');
        } else {
            document.exitFullscreen();
            document.querySelector('.fullscreen-btn i').classList.replace('fa-compress', 'fa-expand');
        }
    }

    document.getElementById('fullscreen-toggle').addEventListener('click', toggleFullscreen);
    /*
ForzaRadio - IA Music Player
Implementing current playing logic from original index.html
*/

new Vue({
    el: "#app",
    data() {
      return {
        audio: null,
        circleLeft: null,
        barWidth: null,
        duration: null,
        currentTime: null,
        isTimerPlaying: false,
        volume: 0.8,
        lastNonZeroVolume: 0.8,
        isMuted: false,
        tracks: [],
        currentTrack: null,
        currentTrackIndex: 0,
        transitionName: null,
        items: [],
        currentIndex: 0,
        isPlaying: false,
        currentSongData: null,
        currentAlbumArt: null,
        nextPreloadStarted: false,
        nextBufferedForIndex: -1,
        bufferPlayer: null,
        PRELOAD_AFTER_SECONDS: 7,
        preloadedImages: new Map(), // Store preloaded images
        SPOTIFY_CONFIG: {
            clientId: '57e7d63ff50e46058facee08174119c7',
            clientSecret: 'c8f8624cc0c245db82a065d2f8182f7c'
        },
        spotifyAccessToken: null,
        spotifyTokenExpiry: null,
        audioCtx: null,
        analyser: null,
        sourceNode: null,
        vizDataArray: null,
        vizRafId: null,
        searchQuery: '',
        showSearchResults: false,
        filteredTracks: []
      };
    },
    methods: {
      async loadSongList() {
        const sources = [
          "https://raw.githubusercontent.com/forzayt/forzaRadio/main/songs.json", // correct raw URL
        ];
        for (const url of sources) {
          try {
            const response = await fetch(url, { cache: "no-store" });
            if (response.ok) {
              const data = await response.json();
              if (Array.isArray(data) && data.length > 0) return data;
            }
          } catch (error) {
            console.warn("Failed to load songs from", url, error);
          }
        }
        console.error('Failed to load songs.json from all sources');
        return [];
      },

      applyVolume(v) {
        const clamped = Math.max(0, Math.min(1, v));
        this.volume = clamped;
        if (this.audio) {
          this.audio.volume = clamped;
          this.isMuted = clamped === 0;
          if (!this.isMuted && clamped > 0) this.lastNonZeroVolume = clamped;
        }
      },

      onVolumeInput(e) {
        const v = parseFloat(e.target.value);
        this.applyVolume(isNaN(v) ? 0 : v);
      },

      toggleMute() {
        if (this.isMuted || this.volume === 0) {
          const restore = this.lastNonZeroVolume > 0 ? this.lastNonZeroVolume : 0.8;
          this.applyVolume(restore);
        } else {
          this.applyVolume(0);
        }
      },

      ensureAudioContext() {
        if (!this.audioCtx) {
          try {
            const Ctx = window.AudioContext || window.webkitAudioContext;
            this.audioCtx = new Ctx();
          } catch (e) {
            console.warn('Web Audio not supported.');
            return false;
          }
        }
        if (this.audioCtx.state === 'suspended') {
          this.audioCtx.resume().catch(()=>{});
        }
        if (!this.analyser) {
          this.analyser = this.audioCtx.createAnalyser();
          this.analyser.fftSize = 256;
        }
        if (!this.sourceNode) {
          try {
            this.sourceNode = this.audioCtx.createMediaElementSource(this.audio);
            this.sourceNode.connect(this.analyser);
            this.analyser.connect(this.audioCtx.destination);
          } catch (e) {
            // In some browsers creating second source for same media throws, ignore
          }
        }
        const bufferLength = this.analyser.frequencyBinCount;
        if (!this.vizDataArray || this.vizDataArray.length !== bufferLength) {
          this.vizDataArray = new Uint8Array(bufferLength);
        }
        return true;
      },

      // Extract ID3 metadata from MP3 files
      async extractID3Metadata(audioElement) {
        try {
          // Create a FileReader to read the audio file
          const response = await fetch(audioElement.src);
          const blob = await response.blob();
          
          // Read the first 10 bytes to check for ID3 header
          const reader = new FileReader();
          
          return new Promise((resolve) => {
            reader.onload = (e) => {
              const arrayBuffer = e.target.result;
              const uint8Array = new Uint8Array(arrayBuffer);
              
              // Check for ID3v2 header (starts with "ID3")
              if (uint8Array[0] === 0x49 && uint8Array[1] === 0x44 && uint8Array[2] === 0x33) {
                const metadata = this.parseID3v2(uint8Array);
                resolve(metadata);
              } else {
                // Try to read the last 128 bytes for ID3v1
                this.readID3v1FromEnd(blob).then(id3v1Metadata => {
                  resolve(id3v1Metadata);
                }).catch(() => {
                  resolve(null);
                });
              }
            };
            
            reader.readAsArrayBuffer(blob.slice(0, 1024)); // Read first 1KB for ID3v2
          });
        } catch (error) {
          console.warn('Failed to extract ID3 metadata:', error);
          return null;
        }
      },

      // Read ID3v1 metadata from the end of the file
      async readID3v1FromEnd(blob) {
        try {
          const reader = new FileReader();
          return new Promise((resolve) => {
            reader.onload = (e) => {
              const arrayBuffer = e.target.result;
              const uint8Array = new Uint8Array(arrayBuffer);
              const metadata = this.parseID3v1(uint8Array);
              resolve(metadata);
            };
            // Read the last 128 bytes of the file
            reader.readAsArrayBuffer(blob.slice(-128));
          });
        } catch (error) {
          console.warn('Failed to read ID3v1 from end:', error);
          return null;
        }
      },

      // Parse ID3v2 metadata
      parseID3v2(uint8Array) {
        const metadata = {};
        
        try {
          console.log('Parsing ID3v2 tag, data length:', uint8Array.length);
          // ID3v2 header is 10 bytes
          const majorVersion = uint8Array[3];
          const flags = uint8Array[5];
          const size = this.syncSafeInt(uint8Array.slice(6, 10));
          
          console.log('ID3v2 version:', majorVersion, 'size:', size);
          let offset = 10;
          
          // Parse frames
          while (offset < size + 10 && offset < uint8Array.length - 4) {
            if (offset + 4 > uint8Array.length) break;
            
            const frameID = String.fromCharCode(uint8Array[offset], uint8Array[offset + 1], uint8Array[offset + 2], uint8Array[offset + 3]);
            offset += 4;
            
            if (offset + 4 > uint8Array.length) break;
            
            const frameSize = this.syncSafeInt(uint8Array.slice(offset, offset + 4));
            offset += 4;
            
            if (offset + 2 > uint8Array.length) break;
            
            const flags2 = uint8Array.slice(offset, offset + 2);
            offset += 2;
            
            if (offset + frameSize > uint8Array.length) break;
            
            // Extract frame data
            const frameData = uint8Array.slice(offset, offset + frameSize);
            
            // Handle text frames
            if (frameID === 'TPE1' || frameID === 'TPE2' || frameID === 'TPE3' || frameID === 'TPE4') {
              // Artist frames
              const text = this.decodeText(frameData);
              console.log('Found artist frame:', frameID, 'text:', text);
              if (text) {
                if (!metadata.contributingArtists) metadata.contributingArtists = [];
                metadata.contributingArtists.push(text);
              }
            } else if (frameID === 'TIT2') {
              // Title
              metadata.title = this.decodeText(frameData);
              console.log('Found title frame:', frameID, 'text:', metadata.title);
            } else if (frameID === 'TALB') {
              // Album
              metadata.album = this.decodeText(frameData);
              console.log('Found album frame:', frameID, 'text:', metadata.album);
            } else if (frameID === 'TYER') {
              // Year
              metadata.year = this.decodeText(frameData);
              console.log('Found year frame:', frameID, 'text:', metadata.year);
            }
            
            offset += frameSize;
          }
          
          // Join contributing artists if multiple
          if (metadata.contributingArtists && metadata.contributingArtists.length > 0) {
            metadata.contributingArtists = metadata.contributingArtists.join(', ');
          }
          
        } catch (error) {
          console.warn('Error parsing ID3v2:', error);
        }
        
        return metadata;
      },

      // Parse ID3v1 metadata
      parseID3v1(uint8Array) {
        const metadata = {};
        
        try {
          console.log('Parsing ID3v1 tag, data length:', uint8Array.length);
          // ID3v1 is in the last 128 bytes
          const start = Math.max(0, uint8Array.length - 128);
          const id3v1Data = uint8Array.slice(start);
          
          if (id3v1Data.length < 128) return metadata;
          
          // Extract fields (30 bytes each for title, artist, album)
          const title = this.decodeID3v1Text(id3v1Data.slice(0, 30));
          const artist = this.decodeID3v1Text(id3v1Data.slice(30, 60));
          const album = this.decodeID3v1Text(id3v1Data.slice(60, 90));
          
          console.log('ID3v1 extracted - title:', title, 'artist:', artist, 'album:', album);
          
          if (title) metadata.title = title;
          if (artist) metadata.contributingArtists = artist;
          if (album) metadata.album = album;
          
        } catch (error) {
          console.warn('Error parsing ID3v1:', error);
        }
        
        return metadata;
      },

      // Decode text from ID3v2 frames
      decodeText(frameData) {
        if (frameData.length < 1) return null;
        
        const encoding = frameData[0];
        const textData = frameData.slice(1);
        
        try {
          if (encoding === 0 || encoding === 3) {
            // ISO-8859-1 or UTF-8
            return new TextDecoder('utf-8').decode(textData);
          } else if (encoding === 1) {
            // UTF-16 with BOM
            return new TextDecoder('utf-16').decode(textData);
          } else if (encoding === 2) {
            // UTF-16BE without BOM
            return new TextDecoder('utf-16be').decode(textData);
          }
        } catch (error) {
          console.warn('Error decoding text:', error);
        }
        
        return null;
      },

      // Decode ID3v1 text (simple ASCII)
      decodeID3v1Text(data) {
        try {
          const text = new TextDecoder('ascii').decode(data);
          return text.replace(/\0+$/, '').trim(); // Remove null bytes and trim
        } catch (error) {
          return null;
        }
      },

      // Convert sync-safe integer (ID3v2 size format)
      syncSafeInt(bytes) {
        return (bytes[0] << 21) + (bytes[1] << 14) + (bytes[2] << 7) + bytes[3];
      },

      startVolumeVisualizer() {
        const canvas = this.$refs.volumeViz;
        if (!canvas) return;
        const parent = canvas.parentElement;
        canvas.width = parent.clientWidth;
        canvas.height = parent.clientHeight;
        const ctx = canvas.getContext('2d');

        const draw = () => {
          if (!this.analyser) return;
          this.analyser.getByteFrequencyData(this.vizDataArray);
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          // Map only lower frequencies for smoother bar
          const sampleCount = 48; // number of segments across width
          const step = Math.floor(this.vizDataArray.length / sampleCount);
          const barWidth = canvas.width / sampleCount;

          for (let i = 0; i < sampleCount; i++) {
            const idx = i * step;
            const val = this.vizDataArray[idx] / 255; // 0..1
            const h = Math.max(2, Math.round(val * canvas.height));

            // Dynamic rainbow similar to progress bar but more lively
            const time = performance.now() * 0.002; // animation speed
            const baseHue = (i / sampleCount) * 360;
            const hue = (baseHue + time * 60 + val * 60) % 360;
            const lightness = 50 + Math.round(val * 20);
            ctx.fillStyle = `hsl(${hue}, 85%, ${lightness}%)`;
            ctx.shadowColor = `hsla(${hue}, 85%, ${lightness}%, 0.6)`;
            ctx.shadowBlur = 8;

            const x = i * barWidth;
            const y = (canvas.height - h) / 2; // center vertically

            // Draw rounded mini-rects forming a continuous bar feel
            const radius = Math.min(3, h / 2);
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + barWidth - radius, y);
            ctx.quadraticCurveTo(x + barWidth, y, x + barWidth, y + radius);
            ctx.lineTo(x + barWidth, y + h - radius);
            ctx.quadraticCurveTo(x + barWidth, y + h, x + barWidth - radius, y + h);
            ctx.lineTo(x + radius, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.fill();
          }

          this.vizRafId = requestAnimationFrame(draw);
        };

        cancelAnimationFrame(this.vizRafId);
        this.vizRafId = requestAnimationFrame(draw);
      },

      formatTime(seconds) {
        if (isNaN(seconds)) return "0:00";
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      },

      updateProgress() {
        if (this.audio.duration) {
          const progressPercent = (this.audio.currentTime / this.audio.duration) * 100;
          this.barWidth = progressPercent + "%";
          this.circleLeft = progressPercent + "%";
          this.currentTime = this.formatTime(this.audio.currentTime);
          this.duration = this.formatTime(this.audio.duration);

          // Start buffering the NEXT track only after some seconds of the CURRENT track
          if (this.isPlaying && !this.nextPreloadStarted && this.audio.currentTime >= this.PRELOAD_AFTER_SECONDS) {
            this.preloadNext();
          }
        }
      },

      async getSpotifyToken() {
        if (this.spotifyAccessToken && Date.now() < this.spotifyTokenExpiry) return this.spotifyAccessToken;
        const res = await fetch('https://accounts.spotify.com/api/token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Authorization': 'Basic ' + btoa(this.SPOTIFY_CONFIG.clientId + ':' + this.SPOTIFY_CONFIG.clientSecret)
          },
          body: 'grant_type=client_credentials'
        });
        const data = await res.json();
        this.spotifyAccessToken = data.access_token;
        this.spotifyTokenExpiry = Date.now() + (data.expires_in * 1000);
        return this.spotifyAccessToken;
      },

      async searchSpotifyAlbumArt(songTitle, artistName) {
        try {
          const token = await this.getSpotifyToken();
          const query = encodeURIComponent(`${songTitle} ${artistName}`);
          const res = await fetch(`https://api.spotify.com/v1/search?q=${query}&type=track&limit=1`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await res.json();
          if (data.tracks.items.length > 0) return data.tracks.items[0].album.images[0].url;
        } catch {}
        return this.getFallbackAlbumArt();
      },

      getFallbackAlbumArt() {
        return 'https://avatars.githubusercontent.com/u/127679210?v=4';
      },

      // Preload album art image
      async preloadAlbumArt(songData) {
        try {
          const imageUrl = await this.searchSpotifyAlbumArt(songData.title, songData.artist);
          const key = `${songData.title}-${songData.artist}`;
          
          if (!this.preloadedImages.has(key)) {
            const img = new Image();
            img.onload = () => {
              this.preloadedImages.set(key, imageUrl);
              console.log(`Preloaded album art for: ${songData.title}`);
            };
            img.onerror = () => {
              console.warn(`Failed to preload album art for: ${songData.title}`);
            };
            img.src = imageUrl;
          }
        } catch (error) {
          console.warn('Error preloading album art:', error);
        }
      },

      // Get preloaded album art or fetch it
      async getAlbumArt(songData) {
        const key = `${songData.title}-${songData.artist}`;
        
        // Check if image is already preloaded
        if (this.preloadedImages.has(key)) {
          return this.preloadedImages.get(key);
        }
        
        // If not preloaded, fetch and cache it
        const imageUrl = await this.searchSpotifyAlbumArt(songData.title, songData.artist);
        this.preloadedImages.set(key, imageUrl);
        return imageUrl;
      },

      async updateSongInfo(songData) {
        this.currentSongData = songData;
        
        // Use preloaded image if available, otherwise fetch it
        const coverUrl = await this.getAlbumArt(songData);
        
        this.currentTrack = {
          name: songData.title || "Unknown Title",
          cover: coverUrl,
          source: songData.audioUrl || songData.filename,
          favorited: false,
          contributingArtists: null
        };
        this.currentAlbumArt = this.currentTrack.cover;
        
        // Extract ID3 metadata if we have an audio source
        if (this.audio && this.audio.src) {
          try {
            console.log('Attempting to extract metadata from:', this.audio.src);
            const metadata = await this.extractID3Metadata(this.audio);
            console.log('Extracted metadata:', metadata);
            if (metadata && metadata.contributingArtists) {
              this.currentTrack.contributingArtists = metadata.contributingArtists;
              console.log('Set contributing artists:', metadata.contributingArtists);
            } else {
              console.log('No contributing artists found in metadata');
            }
          } catch (error) {
            console.warn('Failed to extract metadata:', error);
          }
        }
        
        // Smoothly transition background image
        await this.transitionBackgroundImage(this.currentAlbumArt);
      },

      shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
      },

      normalizeMatch(a, b) {
        if (!a || !b) return false;
        return a === b || a.endsWith(b) || b.endsWith(a);
      },

      preloadNext() {
        if (this.items.length === 0) return;

        // Calculate the next index considering our new logic
        // Since playNext() increments currentIndex at the start, 
        // the next song is at currentIndex + 1
        let nextIndex = this.currentIndex + 1;
        if (nextIndex >= this.items.length) nextIndex = 0;

        const nextSong = this.items[nextIndex];
        const nextSrc = nextSong.audioUrl || nextSong.filename;

        this.bufferPlayer.src = nextSrc;
        this.bufferPlayer.preload = "auto";
        this.bufferPlayer.load?.();
        this.nextPreloadStarted = true;
        this.nextBufferedForIndex = nextIndex;

        // Also preload the album art for the next track
        this.preloadAlbumArt(nextSong);
      },

      async playNext() {
        if (this.items.length === 0) return;

        // Increment currentIndex to get the next song
        this.currentIndex++;
        
        if (this.currentIndex >= this.items.length) {
          this.shuffleArray(this.items);
          this.currentIndex = 0;
        }

        const song = this.items[this.currentIndex];
        const expectedSrc = song.audioUrl || song.filename;
        
        // Set audio source first for metadata extraction
        if (this.nextBufferedForIndex === this.currentIndex &&
            this.normalizeMatch(this.bufferPlayer.src, expectedSrc) &&
            this.bufferPlayer.readyState >= 2) {
          this.audio.src = this.bufferPlayer.src;
          console.log('Using preloaded audio for:', song.title);
        } else {
          this.audio.src = expectedSrc;
          console.log('Loading fresh audio for:', song.title);
        }
        
        // Update song info after setting audio source (this will extract metadata)
        await this.updateSongInfo({ title: song.title, artist: song.artist });

        this.nextPreloadStarted = false;
        this.nextBufferedForIndex = -1;

        this.audio.onerror = () => {
          console.error('Failed to load audio:', song.title);
          this.currentIndex++;
          setTimeout(() => {
            this.playNext().catch(error => {
              console.warn('Error in error handler playNext:', error);
            });
          }, 1000);
        };

        this.audio.oncanplay = () => {
          if (this.isPlaying) {
            this.audio.play().catch(error => {
              console.error('Autoplay failed:', error);
              this.isPlaying = false;
              this.isTimerPlaying = false;
            });
          }
        };
      },

      async playPrev() {
        // Decrement currentIndex by 2 to go back one song
        // (since playNext will increment it by 1)
        this.currentIndex = Math.max(0, this.currentIndex - 2);
        await this.playNext();
      },

      play() {
        // Ensure audio context and visualizer are running on user interaction
        this.ensureAudioContext();
        this.startVolumeVisualizer();
        if (this.audio.paused) {
          this.audio.play();
          this.isTimerPlaying = true;
          this.isPlaying = true;
        } else {
          this.audio.pause();
          this.isTimerPlaying = false;
          this.isPlaying = false;
        }
      },

      clickProgress(e) {
        this.isTimerPlaying = true;
        this.isPlaying = true;
        this.audio.pause();
        this.updateBar(e.pageX);
      },

      updateBar(x) {
        let progress = this.$refs.progress;
        let maxduration = this.audio.duration;
        let position = x - progress.offsetLeft;
        let percentage = (100 * position) / progress.offsetWidth;
        if (percentage > 100) {
          percentage = 100;
        }
        if (percentage < 0) {
          percentage = 0;
        }
        this.barWidth = percentage + "%";
        this.circleLeft = percentage + "%";
        this.audio.currentTime = (maxduration * percentage) / 100;
        this.audio.play();
      },

      async prevTrack() {
        this.transitionName = "scale-in";
        await this.playPrev();
      },

      async nextTrack() {
        this.transitionName = "scale-out";
        await this.playNext();
      },

      favorite() {
        if (this.currentTrack) {
          this.currentTrack.favorited = !this.currentTrack.favorited;
        }
      },

      async initPlayer() {
        this.items = await this.loadSongList();
        if (this.items.length === 0) {
          this.currentTrack = {
            name: "No songs available",
            cover: this.getFallbackAlbumArt(),
            source: "",
            favorited: false
          };
          return;
        }
        this.shuffleArray(this.items);
        this.currentIndex = 0;

        const song = this.items[this.currentIndex];
        await this.updateSongInfo({ title: song.title, artist: song.artist });
        this.audio.src = song.audioUrl || song.filename;

        this.nextPreloadStarted = false;
        this.nextBufferedForIndex = -1;

        // Don't increment currentIndex here - it should point to the currently playing song
        // this.currentIndex++;
        
        // Start preloading the next song
        setTimeout(() => {
          this.preloadNext();
        }, 2000);
      },



      // Smoothly transition background image
      async transitionBackgroundImage(newImageUrl) {
        const bgImg = document.getElementById('bg-img');
        if (bgImg) {
          // Create a temporary image to preload
          const tempImg = new Image();
          tempImg.onload = () => {
            // Once loaded, smoothly transition the background
            bgImg.style.transition = 'opacity 0.5s ease-in-out';
            bgImg.style.opacity = '0';
            
            setTimeout(() => {
              bgImg.src = newImageUrl;
              bgImg.style.opacity = '1';
            }, 250);
          };
          tempImg.src = newImageUrl;
        }
      },

      performSearch() {
        if (!this.searchQuery.trim()) {
          this.filteredTracks = [];
          this.showSearchResults = false;
          return;
        }
        
        const query = this.searchQuery.toLowerCase().trim();
        this.filteredTracks = this.items.filter(track => {
          const title = (track.title || '').toLowerCase();
          const artist = (track.artist || '').toLowerCase();
          const album = (track.album || '').toLowerCase();
          
          return title.includes(query) || 
                 artist.includes(query) || 
                 album.includes(query);
        });
        
        this.showSearchResults = this.filteredTracks.length > 0;
      },

      clearSearch() {
        this.searchQuery = '';
        this.filteredTracks = [];
        this.showSearchResults = false;
      },

      handleSearchBlur() {
        // Delay hiding to allow clicking on results
        setTimeout(() => {
          this.showSearchResults = false;
        }, 200);
      },

      handleSearchEnter() {
        if (this.filteredTracks.length > 0) {
          this.playSearchResult(this.filteredTracks[0], 0);
        }
      },

      async playSearchResult(track, index) {
        // Find the actual index of this track in the main items array
        const actualIndex = this.items.findIndex(item => 
          item.title === track.title && item.artist === track.artist
        );
        
        if (actualIndex !== -1) {
          // Set the current index to play this track
          this.currentIndex = actualIndex;
          
          // Set the audio source first so metadata extraction can work
          this.audio.src = track.audioUrl || track.filename;
          this.audio.load();
          
          // Update the current track info (this will now extract metadata)
          await this.updateSongInfo({
            title: track.title,
            artist: track.artist,
            album: track.album
          });
          
          // Play the track
          this.play();
          
          // Hide search results
          this.showSearchResults = false;
          this.searchQuery = '';
          this.filteredTracks = [];
          
          // Reset preload state since we're playing a different song
          this.nextPreloadStarted = false;
          this.nextBufferedForIndex = -1;
          
          // Start preloading the next song immediately
          setTimeout(() => {
            this.preloadNext();
          }, 1000);
        }
      },

      getFallbackAlbumArt() {
        return 'https://avatars.githubusercontent.com/u/127679210?v=4';
      },

      handleImageError(event) {
        event.target.src = this.getFallbackAlbumArt();
      }
    },
    async created() {
      let vm = this;
      
      // Initialize buffer player
      this.bufferPlayer = new Audio();
      this.bufferPlayer.crossOrigin = "anonymous";
      this.bufferPlayer.preload = "auto";

      // Initialize main audio
      this.audio = new Audio();
      this.audio.crossOrigin = "anonymous";
      this.audio.playsInline = true;
      this.audio.preload = "auto";
      this.audio.volume = this.volume;
      
      this.audio.ontimeupdate = function() {
        vm.updateProgress();
      };
      
      this.audio.onloadedmetadata = function() {
        vm.updateProgress();
      };
      
        this.audio.onended = function() {
          vm.playNext().then(() => {
            vm.isTimerPlaying = true;
            vm.isPlaying = true;
          });
        };

      // Initialize player
      await this.initPlayer();

      // Prepare AudioContext and start visualizer after first user interaction
      const kickstart = () => {
        if (this.ensureAudioContext()) {
          this.startVolumeVisualizer();
        }
        window.removeEventListener('click', kickstart);
        window.removeEventListener('touchstart', kickstart);
      };
      window.addEventListener('click', kickstart, { once: true });
      window.addEventListener('touchstart', kickstart, { once: true });

      // Keep visualizer responsive to resize
      window.addEventListener('resize', () => {
        const canvas = this.$refs.volumeViz;
        if (canvas && canvas.parentElement) {
          canvas.width = canvas.parentElement.clientWidth;
          canvas.height = canvas.parentElement.clientHeight;
        }
      });

      // Fallback: Check if song has ended but event didn't fire
      setInterval(() => {
        if (this.isPlaying && this.audio.duration && this.audio.currentTime >= this.audio.duration - 0.1) {
          this.playNext().catch(error => {
            console.warn('Error in fallback playNext:', error);
          });
        }
      }, 1000);
    }
  });
  
    </script>
</body>

</html>